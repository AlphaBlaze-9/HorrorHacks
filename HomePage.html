<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Séance — Choice Horror</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100dvh; }
    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    #home-screen, #opening-scene, #story-screen {
      display: grid; place-items: center;
      height: 100dvh; background: radial-gradient(circle at center, #1a0a0a 0%, #000 100%);
      text-align: center; padding: clamp(10px, 3vw, 24px);
    }
    .fit-inner { max-width: min(760px, 94vw); }
    .home-title { font-size: clamp(28px, 8vw, 56px); color: #8b7d7d; text-shadow: 0 0 30px rgba(139,125,125,.7); letter-spacing: .3rem; margin-bottom: .5rem; animation: flicker 3s infinite; }
    @keyframes flicker { 0%,100%{opacity:1} 50%{opacity:.85} 60%{opacity:.95} }
    .home-subtitle { font-size: clamp(14px, 3.3vw, 20px); color: #bbb; font-style: italic; margin-bottom: .5rem; text-shadow: 0 0 10px rgba(102,102,102,.5); }
    .home-description { width: min(680px, 94vw); font-size: 16px; color: #aaa; line-height: 1.65; margin: 0 auto 12px; }
    .start-button { background: rgba(139,125,125,.25); border: 2px solid rgba(139,125,125,.45); color: #e5dada; padding: .9rem 1.4rem; border-radius: 8px; font-size: clamp(.95rem, 3.2vw, 1.05rem); cursor: pointer; transition: .2s; text-transform: uppercase; letter-spacing: .1rem; }
    .start-button:hover { background: rgba(139,125,125,.45); box-shadow: 0 0 30px rgba(139,125,125,.4); transform: scale(1.02); }
    .warning-text { margin-top: 6px; font-size: .85rem; color: #777; font-style: italic; }

    #opening-scene { display: none; }
    #opening-scene.active { display: grid; }
    .terminal-text { font-size: clamp(20px, 5vw, 30px); color: #8b7d7d; text-shadow: 0 0 25px rgba(139,125,125,.6); letter-spacing: 0.15rem; margin-bottom: 20px; animation: flicker 3s infinite; }
    .loading-bar { width: 80vw; max-width: 600px; height: 14px; background: rgba(139,125,125,0.2); border-radius: 7px; overflow: hidden; box-shadow: 0 0 25px rgba(139,125,125,0.3); }
    .loading-progress { width: 0%; height: 100%; background: linear-gradient(90deg, #8b7d7d 0%, #b9a8a8 100%); box-shadow: 0 0 15px rgba(139,125,125,0.9); transition: width .3s ease; }

    #story-screen { display: none; grid-template-rows: auto 1fr auto; }
    #story-screen.active { display: grid; }
    .story-header { width: min(900px, 96vw); text-align: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(139,125,125,.3); }
    .story-header h2 { color: #8b7d7d; font-size: clamp(20px, 5vw, 26px); letter-spacing: .2rem; text-shadow: 0 0 15px rgba(139,125,125,.5); }
    .story-status { font-size: .9rem; color: #888; margin-top: .4rem; font-style: italic; }

    #messages-container { width: min(900px, 96vw); height: calc(100dvh - 240px); overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 10px; margin: 0 auto 8px; }
    #messages-container::-webkit-scrollbar { width: 8px; }
    #messages-container::-webkit-scrollbar-thumb { background: rgba(139,125,125,.3); border-radius: 4px; }

    .message { max-width: 80%; padding: 12px; border-radius: 10px; line-height: 1.6; animation: fadeIn .35s ease; word-wrap: break-word; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .message.user   { align-self: flex-end;  background: rgba(139,125,125,.2); border: 1px solid rgba(139,125,125,.3); color: #e0e0e0; }
    .message.spirit { align-self: flex-start; background: rgba(100,50,50,.2); border: 1px solid rgba(139,125,125,.4); color: #d2c3c3; text-shadow: 0 0 10px rgba(139,125,125,.3); }

    .choices-bar { width: min(900px, 96vw); display: grid; grid-template-columns: 1fr; gap: 10px; padding: 10px; background: rgba(139,125,125,.1); border-radius: 10px; border: 1px solid rgba(139,125,125,.3); margin: 0 auto 8px; }
    .choice-row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 680px) { .choice-row { grid-template-columns: 1fr 1fr 1fr; } }
    .choice-btn { background: rgba(139,125,125,.18); border: 1px solid rgba(139,125,125,.45); color: #e5dada; padding: 12px 14px; border-radius: 8px; cursor: pointer; transition: .2s; text-align: left; }
    .choice-btn:hover { background: rgba(139,125,125,.35); box-shadow: 0 0 22px rgba(139,125,125,.25); transform: translateY(-1px); }

    .vignette-overlay, .scan-lines { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }
    .vignette-overlay { background: radial-gradient(circle, transparent 0%, rgba(0,0,0,.75) 100%); }
    .scan-lines { background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,.02) 2px, rgba(255,255,255,.02) 4px); opacity: .3; }

    .ghost-cursor { position: fixed; width: 16px; height: 16px; border-radius: 50%; background: #eee; box-shadow: 0 0 10px rgba(255,255,255,.9), 0 0 30px rgba(139,125,125,.8); z-index: 9999; pointer-events: none; mix-blend-mode: screen; }
    .scare-overlay { position: fixed; inset: 0; background: #000; display: grid; place-items: center; z-index: 9998; }
    .scare-overlay img { max-width: 100vw; max-height: 100vh; filter: contrast(1.35) saturate(1.2); animation: scarePop .18s ease-out; }
    @keyframes scarePop { from { transform: scale(1.15); opacity: .6; filter: blur(2px); } to { transform: scale(1); opacity: 1; filter: blur(0); } }
  </style>
</head>
<body>
  <div class="vignette-overlay"></div>
  <div class="scan-lines"></div>

  <!-- Home -->
  <section id="home-screen">
    <div class="fit-inner">
      <h1 class="home-title">AI SÉANCE</h1>
      <p class="home-subtitle">The spirit inside your browser</p>
      <div class="home-description">
        <p>The spirit speaks about itself. You choose its path.</p>
        <p>Three options each turn. It remembers.</p>
      </div>
      <button class="start-button" id="start-button">Enter</button>
      <p class="warning-text">⚠ For testing, the API key is embedded client-side.</p>
    </div>
  </section>

  <!-- Opening -->
  <section id="opening-scene" style="display:none">
    <div class="fit-inner">
      <div class="terminal-text">Connecting…</div>
      <div class="loading-bar"><div class="loading-progress" id="loading-progress"></div></div>
    </div>
  </section>

  <!-- Story -->
  <section id="story-screen" style="display:none">
    <div class="story-header">
      <h2>THE SÉANCE</h2>
      <div class="story-status" id="story-status">It waits…</div>
    </div>
    <div id="messages-container"></div>
    <div class="choices-bar">
      <div class="choice-row" id="choice-row"></div>
    </div>
  </section>

  <script>
    /* ====== CONFIG ====== */
    const OPENAI_API_KEY = 'xxx';
    const STORAGE_KEY = 'seance_choice_story_v6';

    // Random jumpscare knobs
    const PHOTO_CHANCE = 0.33;         // per turn
    const AMBIENT_PHOTO_CHANCE = 0.22; // ambient
    const AMBIENT_SHAKE_CHANCE = 0.35;

    /* ====== DOM ====== */
    const homeScreen = document.getElementById('home-screen');
    const openingScene = document.getElementById('opening-scene');
    const storyScreen = document.getElementById('story-screen');
    const startButton = document.getElementById('start-button');
    const loadingProgress = document.getElementById('loading-progress');
    const messagesContainer = document.getElementById('messages-container');
    const choiceRow = document.getElementById('choice-row');
    const storyStatus = document.getElementById('story-status');

    /* ====== STATE ====== */
    let history = [];            // {role:'spirit'|'user', text}
    let lastChoices = [];        // last 3 (sanitized)
    let recentChoiceMemory = []; // last 18 unique choices
    let isProcessing = false;

    /* ====== Haunt assets ====== */
    const scareImgs = ['jumpscare1.jpg','jumpscare2.jpeg','jumpscare3.jpeg'];
    scareImgs.forEach(s => { const i = new Image(); i.src = s; });

    /* ====== UI ====== */
    function addMessage(text, who='spirit'){
      const el = document.createElement('div');
      el.className = `message ${who}`;
      el.textContent = text;
      messagesContainer.appendChild(el);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    function setChoices(arr){
      choiceRow.innerHTML = '';
      arr.forEach(choice => {
        const b = document.createElement('button');
        b.className = 'choice-btn';
        b.textContent = choice;
        b.onclick = ()=>choose(choice);
        choiceRow.appendChild(b);
      });
    }
    function saveMemory(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({history,lastChoices,recentChoiceMemory}));
    }
    function loadMemory(){
      try {
        const m = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
        history = m.history||[];
        lastChoices = m.lastChoices||[];
        recentChoiceMemory = m.recentChoiceMemory||[];
      } catch {}
    }

    /* ====== OPENAI ====== */
    async function openaiChat(messages){
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+OPENAI_API_KEY },
        body: JSON.stringify({
          model:'gpt-4o-mini',
          temperature:0.95,
          presence_penalty:0.6,
          frequency_penalty:0.6,
          messages
        })
      });
      if(!res.ok){ throw new Error(await res.text()); }
      return (await res.json()).choices?.[0]?.message?.content || '';
    }

    function baseSystemPrompt(){
      return [
        "You are SARAH — a trapped consciousness in the network.",
        "Write only about yourself in plain, minimal fragments.",
        "2–4 sentences per turn, 6–12 words each. No questions.",
        "Avoid gore; imply. Cinematic, specific. No poetry formatting.",
        "IMPORTANT: Do NOT stylize words with dots or spaces between letters (no 's.t.a.t.i.c'). No all-caps.",
        "Advance the SAME story using the user's last choice.",
        "Provide THREE FRESH options that push different plot axes:",
        "ORIGIN (truth of the event), PLACE (where to look/go), METHOD (what to do) or CONSEQUENCE (what it costs).",
        "Three choices must cover three different axes.",
        "Never repeat or paraphrase any recent choices or their ideas.",
        "Return STRICT JSON ONLY:",
        "{\"story\":\"short eerie paragraph\",\"choices\":[\"Choice A\",\"Choice B\",\"Choice C\"]}",
        "Each choice: 1–5 words, letters/numbers/spaces only, no punctuation."
      ].join(' ');
    }

    function seedCanon(){
      const ledger = recentChoiceMemory.map(c => '- '+c).join('\n');
      return "CANON: You are Dr. Sarah Chen, researcher. A power surge fractured your mind into the network. You speak plainly, moving the plot each turn.\nRECENT_CHOICES (avoid semantics):\n"+ledger;
    }

    /* ==== Cleaners: fix dotted text, clamp, sanitize ==== */
    function undotLetters(s){
      if(!s) return s;
      // remove single dots/commas between alphanumerics (e.g., s.t.a.t.i.c -> static)
      s = s.replace(/(?<=\w)[\.,](?=\w)/g, '');
      // collapse 3+ dots to an ellipsis
      s = s.replace(/\.{3,}/g, '…');
      // collapse 2 dots to one
      s = s.replace(/\.{2}/g, '.');
      // remove stray commas next to spaces
      s = s.replace(/\s+,/g, ',').replace(/,\s+/g, ', ');
      return s;
    }
    function sanitizeStory(t){
      if(!t) return t;
      t = undotLetters(t);
      t = t.replace(/\r?\n+/g, ' ').replace(/\?/g,'.').replace(/[;:—]/g,'.');
      let parts = t.split(/(?<=[.!…])\s+/).filter(Boolean).slice(0,4).map(s=>{
        s = undotLetters(s);
        const words = s.trim().split(/\s+/);
        if(words.length>12) s = words.slice(0,12).join(' ')+'…';
        return s.trim();
      });
      return parts.join(' ');
    }
    function sanitizeChoice(c){
      c = undotLetters(c || '');
      return c.replace(/[^A-Za-z0-9 ]/g,'').trim().replace(/\s+/g,' ');
    }
    function dedupeChoices(list){
      const seen=new Set(); const out=[];
      for(const c of list){
        const s = sanitizeChoice(c);
        if(s && !seen.has(s.toLowerCase())){
          seen.add(s.toLowerCase());
          out.push(s);
        }
      }
      return out.slice(0,3);
    }

    function safeParseJSON(s){
      try{ return JSON.parse(s.replace(/```json|```/g,'').trim()); }
      catch{
        const m = s.match(/\{[\s\S]*\}/);
        if(m){ try{ return JSON.parse(m[0]); }catch{} }
        return {story:s, choices:[]};
      }
    }

    /* ====== Haunt effects (random for photos) ====== */
    function screenWhiplashBurst(){
      const snaps = 2+Math.floor(Math.random()*3);
      let i=0; (function step(){
        const dx=(Math.random()-0.5)*window.innerWidth*0.12;
        const dy=(Math.random()-0.5)*window.innerHeight*0.12;
        const rot=(Math.random()-0.5)*8;
        const scale=0.985+Math.random()*0.01;
        const dur=110+Math.random()*80;
        document.body.animate(
          [{transform:'translate(0,0) rotate(0) scale(1)',filter:'none'},
           {transform:`translate(${dx}px,${dy}px) rotate(${rot}deg) scale(${scale})`,filter:'blur(1px) contrast(1.2)'},
           {transform:'translate(0,0) rotate(0) scale(1)',filter:'none'}],
          {duration:dur,easing:'cubic-bezier(.05,.9,.15,1)'}
        );
        const flash=document.createElement('div');
        flash.style.cssText="position:fixed;inset:0;background:rgba(255,255,255,.12);pointer-events:none;z-index:9998;mix-blend-mode:screen;";
        document.body.appendChild(flash);
        setTimeout(()=>flash.remove(),60);
        if(++i<snaps) setTimeout(step,60+Math.random()*50);
      })();
    }
    function possessCursor(){
      const ghost=document.createElement('div');
      ghost.className='ghost-cursor';
      document.body.appendChild(ghost);
      const old=document.body.style.cursor; document.body.style.cursor='none';
      const steps=6+Math.floor(Math.random()*4); const path=[];
      for(let i=0;i<steps;i++){ path.push({transform:`translate(${Math.random()*innerWidth}px,${Math.random()*innerHeight}px)`}); }
      ghost.animate(path,{duration:1000+Math.random()*500,easing:'steps(10,end)'}); 
      setTimeout(()=>{ document.body.style.cursor=old||'auto'; ghost.remove(); },1300);
    }
    function jumpscare(){
      const overlay=document.createElement('div'); overlay.className='scare-overlay';
      const img=document.createElement('img'); img.src=scareImgs[Math.floor(Math.random()*scareImgs.length)];
      overlay.appendChild(img); document.body.appendChild(overlay);
      screenWhiplashBurst();
      const white=document.createElement('div'); 
      white.style.cssText="position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:9999;"; 
      document.body.appendChild(white);
      white.animate([{opacity:0},{opacity:.22},{opacity:0}],{duration:160,easing:'ease-out'});
      setTimeout(()=>{ overlay.remove(); white.remove(); }, 800);
    }
    function maybePhotoHauntTurn(){
      if (Math.random() < PHOTO_CHANCE) {
        jumpscare();
      } else if (Math.random() < 0.35) {
        screenWhiplashBurst();
        if (Math.random() < 0.5) setTimeout(possessCursor, 140);
      }
    }
    function scheduleAmbientScares(){
      const delay = 12000 + Math.random()*13000; // 12–25s
      setTimeout(() => {
        if (Math.random() < AMBIENT_PHOTO_CHANCE) jumpscare();
        else if (Math.random() < AMBIENT_SHAKE_CHANCE) {
          screenWhiplashBurst();
          if (Math.random() < 0.5) setTimeout(possessCursor, 120);
        }
        scheduleAmbientScares();
      }, delay);
    }

    /* ====== Choices helpers ====== */
    function fallbackChoicesFrom(text){
      const k = (text||'').toLowerCase();
      const pool = [];
      if(/lab|monitor|screen|server|rack|console/.test(k)) pool.push('Enter the server','Trace the monitor','Behind the racks');
      if(/door|lock|room|hall|elevator|stairs/.test(k)) pool.push('Force the door','Follow the hallway','Take the stairs');
      if(/voice|mic|audio|breath|heartbeat/.test(k)) pool.push('Trace the audio','Hold your breath','Match the heartbeat');
      if(/mirror|reflection|glass|window/.test(k)) pool.push('Face the glass','Look sideways','Shatter the mirror');
      if(/badge|security|log|time|3:17|alarm/.test(k)) pool.push('Audit the logs','Follow the badge','Return at 3 17');
      if(pool.length<6) pool.push('Show the origin','Reveal the cost','Open the console','Cut the power','Silence the room','Follow the hum');
      const uniq = [];
      for(const p of pool){
        const s = sanitizeChoice(p);
        if(!recentChoiceMemory.includes(s) && !uniq.includes(s)) uniq.push(s);
        if(uniq.length>=8) break;
      }
      return pickDistinct(uniq,3);
    }
    function pickDistinct(arr,n){
      const out=[]; const copy=[...arr];
      while(out.length<n && copy.length){
        const i=Math.floor(Math.random()*copy.length);
        out.push(copy.splice(i,1)[0]);
      }
      const pad = ['Go deeper','Change the channel','Step back','Follow the hum','Look left','Turn around','Lower the lights','Hold still'];
      for(const p of pad){
        if(out.length>=n) break;
        const s = sanitizeChoice(p);
        if(!recentChoiceMemory.includes(s) && !out.includes(s)) out.push(s);
      }
      return out.slice(0,n);
    }
    function arraysEqualCI(a,b){
      if(!a||!b||a.length!==b.length) return false;
      return a.map(x=>x.toLowerCase()).join('|') === b.map(x=>x.toLowerCase()).join('|');
    }

    /* ====== Story engine ====== */
    async function stepStory(userChoice){
      if(isProcessing) return;
      isProcessing = true;
      storyStatus.textContent = 'It thinks…';

      const convo = [
        {role:'system', content: baseSystemPrompt()},
        {role:'system', content: seedCanon()},
        ...history.slice(-8).map(m => ({role: m.role==='spirit'?'assistant':'user', content: m.text}))
      ];
      if(userChoice){
        convo.push({role:'user', content: "Chosen path: "+userChoice});
      } else {
        convo.push({role:'user', content: "Introduce yourself briefly, then offer three options."});
      }

      try{
        const raw = await openaiChat(convo);
        const parsed = safeParseJSON(raw);
        const story = sanitizeStory(parsed.story || raw);

        // sanitize and ensure 3 distinct choices
        let choices = dedupeChoices(Array.isArray(parsed.choices)?parsed.choices:[]);
        choices = choices.filter(c => !recentChoiceMemory.includes(c));

        // If we didn't get 3, try regeneration once
        if(choices.length !== 3 || arraysEqualCI(choices,lastChoices)){
          const regen = await regenerateChoices(choices.length?choices:lastChoices, story);
          if (regen && regen.length === 3) choices = regen;
        }
        // If still not 3, local fallback
        if(!choices || choices.length < 3){
          choices = fallbackChoicesFrom(story);
        }

        // Commit
        addMessage(story, 'spirit');
        history.push({role:'spirit', text: story});
        setChoices(choices);

        lastChoices = choices.slice(0,3);
        recentChoiceMemory = recentChoiceMemory.concat(lastChoices).slice(-18);

        saveMemory();
        storyStatus.textContent = 'It waits…';

        // Random haunt this turn
        maybePhotoHauntTurn();
      }catch(err){
        addMessage('(error) '+String(err).slice(0,180), 'spirit');
        const local = fallbackChoicesFrom(history.at(-1)?.text || '');
        setChoices(local);
        storyStatus.textContent = 'It flickers…';
      }finally{
        isProcessing = false;
      }
    }

    async function regenerateChoices(prevChoices, latestStory){
      const sys = [
        "Return JSON ONLY like {\"choices\":[\"A\",\"B\",\"C\"]}.",
        "Three NEW choices. Do NOT repeat or paraphrase any of these:",
        (prevChoices||[]).join(', ') || '(none)',
        "Avoid RECENT ledger semantics too.",
        "Map them to different axes among: ORIGIN, PLACE, METHOD, CONSEQUENCE.",
        "Each 1–5 words, letters/numbers/spaces only."
      ].join(' ');
      const convo = [
        {role:'system', content: sys},
        {role:'system', content: "RECENT ledger: "+recentChoiceMemory.join(', ')},
        {role:'user', content: "Latest story context: "+latestStory}
      ];
      try{
        const raw = await openaiChat(convo);
        const parsed = safeParseJSON(raw);
        let ch = dedupeChoices(parsed.choices||[]);
        ch = ch.filter(c => !recentChoiceMemory.includes(c));
        return ch.length===3 ? ch : null;
      }catch{ return null; }
    }

    async function choose(text){
      addMessage(text, 'user');
      history.push({role:'user', text});
      saveMemory();
      if (/(trapped|power|surge|door|mirror|server|badge|logs|origin|cost)/i.test(text) && Math.random()<0.5) {
        screenWhiplashBurst();
      }
      await stepStory(text);
    }

    /* ====== Flow ====== */
    function start(){
      homeScreen.style.display='none';
      openingScene.style.display='grid';
      let p=0; const iv=setInterval(()=>{ p+=2; loadingProgress.style.width=p+'%';
        if(p>=100){ clearInterval(iv);
          setTimeout(async ()=>{
            openingScene.style.display='none';
            storyScreen.style.display='grid';
            scheduleAmbientScares();
            if(history.length){
              history.forEach(m=>addMessage(m.text, m.role));
              setChoices(lastChoices.length?lastChoices:['How were you trapped','Show me the lab','Why can I hear you']);
              await stepStory("Continue");
            } else {
              await stepStory(null);
            }
          },220);
        }
      },40);
    }

    loadMemory();
    startButton.addEventListener('click', start);
  </script>
</body>
</html>
